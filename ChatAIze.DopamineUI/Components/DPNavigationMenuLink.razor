@implements ITaggable
@inject NavigationManager NavigationManager

<button class="@LinkClass" ontouchstart="" @onclick="NavigateToPath">
    <CascadingValue Value="Context">
        @ChildContent
    </CascadingValue>
</button>

@code {
    /// <summary>
    /// Gets or sets the navigation path to navigate to.
    /// </summary>
    [Parameter]
    public string? Path { get; set; }

    /// <summary>
    /// Gets or sets the content displayed for the menu link.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the link is disabled.
    /// </summary>
    [Parameter]
    public bool IsDisabled { get; set; }

    /// <summary>
    /// Gets or sets user data associated with the component.
    /// </summary>
    [Parameter]
    public object? Tag { get; set; }

    [CascadingParameter]
    private UIContext ParentContext { get; set; } = new();

    private UIContext Context => ParentContext with { IsDisabled = ParentContext.IsDisabled || IsDisabled };

    private bool IsSelected
    {
        get
        {
            // Root must match exactly, other paths use prefix match for nested routes.
            if (Path == "/")
            {
                return ActivePath == "/";
            }

            return ActivePath.StartsWith(Path ?? string.Empty, StringComparison.OrdinalIgnoreCase);
        }
    }

    private string ActivePath => "/" + NavigationManager.ToBaseRelativePath(NavigationManager.Uri);

    private string LinkClass
    {
        get
        {
            if (IsSelected)
            {
                if (Context.IsDisabled)
                {
                    return "dp-navigation-menu-link-selected-disabled";
                }

                return "dp-navigation-menu-link-selected";
            }

            if (Context.IsDisabled)
            {
                return "dp-navigation-menu-link-disabled";
            }

            return "dp-navigation-menu-link";
        }
    }

    private void NavigateToPath()
    {
        if (!Context.IsDisabled && !string.IsNullOrWhiteSpace(Path))
        {
            Context.NavigationView?.Close();
            NavigationManager.NavigateTo(Path);
        }
    }
}
