@implements ITaggable

<div class="space-y-3">
    <div>
        @if (!string.IsNullOrWhiteSpace(Label))
        {
            <label class="dp-label-base">
                <span class="@LabelClass">@Label</span>
                @if (Value >= MaxValue && !string.IsNullOrWhiteSpace(MaxValueLabel))
                {
                    <span class="@LabelClass"> — </span>
                    <span class="@LabelClass">@MaxValueLabel</span>
                }
                else if (Value <= 0.0 && !string.IsNullOrWhiteSpace(ZeroLabel))
                {
                    <span class="@LabelClass"> — </span>
                    <span class="@LabelClass">@ZeroLabel</span>
                }
                else
                {
                    @if (IsShowingValue)
                    {
                        <span class="@LabelClass"> — </span>
                        <span class="@LabelClass">@Value</span>
                        @if (IsShowingMaxValue)
                        {
                            <span class="@LabelClass text-xs"> / </span>
                            <span class="@LabelClass">@MaxValue</span>
                        }
                        @if (!string.IsNullOrWhiteSpace(Unit))
                        {
                            <span class="@LabelClass">@Unit</span>
                        }
                    }
                    @if (IsShowingPercentage)
                    {
                        <span class="@LabelClass"> — </span>
                        <span class="@LabelClass">@Math.Round(ActualValue, 2)%</span>
                    }
                }
            </label>
        }
        <div class="dp-progressbar @WidthClass">
            <div class="@FillClass" style="width: @Math.Round(Math.Clamp(ActualValue, 0.0, 100.0))%"></div>
        </div>
    </div>
    @if (!string.IsNullOrWhiteSpace(Caption))
    {
        <div class="@CaptionClass">@Caption</div>
    }
</div>

@code {
    /// <summary>
    /// Gets or sets the label displayed above the progress bar.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Gets or sets helper text displayed under the progress bar.
    /// </summary>
    [Parameter]
    public string? Caption { get; set; }

    /// <summary>
    /// Gets or sets the unit label displayed with the value.
    /// </summary>
    [Parameter]
    public string? Unit { get; set; }

    /// <summary>
    /// Gets or sets the current value.
    /// </summary>
    [Parameter]
    public double Value { get; set; } = 0.5;

    /// <summary>
    /// Gets or sets a custom label displayed when the value is zero.
    /// </summary>
    [Parameter]
    public string? ZeroLabel { get; set; }

    /// <summary>
    /// Gets or sets the maximum value.
    /// </summary>
    [Parameter]
    public int MaxValue { get; set; } = 100;

    /// <summary>
    /// Gets or sets a custom label displayed when the value reaches the maximum.
    /// </summary>
    [Parameter]
    public string? MaxValueLabel { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the current value is shown in the label.
    /// </summary>
    [Parameter]
    public bool IsShowingValue { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the maximum value is shown in the label.
    /// </summary>
    [Parameter]
    public bool IsShowingMaxValue { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether percentage progress is shown in the label.
    /// </summary>
    [Parameter]
    public bool IsShowingPercentage { get; set; }

    /// <summary>
    /// Gets or sets whether the progress bar should stretch to full width.
    /// </summary>
    [Parameter]
    public bool? IsFullWidth { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the progress bar is disabled.
    /// </summary>
    [Parameter]
    public bool IsDisabled { get; set; }

    /// <summary>
    /// Gets or sets user data associated with the component.
    /// </summary>
    [Parameter]
    public object? Tag { get; set; }

    [CascadingParameter]
    private UIContext ParentContext { get; set; } = new();

    private UIContext Context => ParentContext with { IsDisabled = ParentContext.IsDisabled || IsDisabled };

    private double ActualValue => MaxValue == 0.0 ? 0.0 : (Value / MaxValue) * 100.0;

    private string LabelClass => Context.IsDisabled ? "dp-label-disabled" : "dp-label";

    private string FillClass => Context.IsDisabled ? "dp-progressbar-fill-disabled" : "dp-progressbar-fill";

    private string CaptionClass
    {
        get
        {
            var captionClass = Context.IsDisabled ? "dp-caption-disabled" : "dp-caption";

            if (!string.IsNullOrWhiteSpace(Label))
            {
                captionClass += " px-3";

            }

            return captionClass;
        }
    }

    private string WidthClass
    {
        get
        {
            if (IsFullWidth == true)
            {
                return "w-full min-w-fit";
            }

            if (IsFullWidth == false)
            {
                return "w-64";
            }

            return "w-full sm:w-64 min-w-fit";
        }
    }
}
