@implements ITaggable

<div class="space-y-3 @WidthClass">
    <div class="relative">
        @if (!string.IsNullOrWhiteSpace(Label))
        {
            <label class="dp-label-base">
                <span class="@LabelClass">@Label</span>
                @if (Value >= MaxValue && !string.IsNullOrWhiteSpace(MaxValueLabel))
                {
                    <span class="@LabelClass"> — </span>
                    <span class="@LabelClass">@MaxValueLabel</span>
                }
                else if (Value <= MinValue && !string.IsNullOrWhiteSpace(MinValueLabel))
                {
                    <span class="@LabelClass"> — </span>
                    <span class="@LabelClass">@MinValueLabel</span>
                }
                else
                {
                    @if (IsShowingValue)
                    {
                        <span class="@LabelClass"> — </span>
                        <span class="@LabelClass">@Value</span>
                        @if (IsShowingMaxValue)
                        {
                            <span class="@LabelClass text-xs"> / </span>
                            <span class="@LabelClass">@MaxValue</span>
                        }
                        @if (!string.IsNullOrWhiteSpace(Unit))
                        {
                            <span class="@LabelClass">@Unit</span>
                        }
                    }
                    @if (IsShowingPercentage)
                    {
                        <span class="@LabelClass"> — </span>
                        <span class="@LabelClass">@Math.Round(Percentage, 2)%</span>
                    }
                }
                <span class="@EditIndicatorClass">●</span>
            </label>
        }
        <div class="absolute bottom-0 flex h-2 mb-1.5 rounded-full overflow-hidden @WidthClass">
            <div class="@FillClass @WidthClass" style="width: @Math.Round(Math.Clamp(Percentage, 0.0, 100.0))%" />
        </div>
        <input id="@_id" type="range" class="@SliderClass @WidthClass" min="@MinValue" max="@MaxValue" step="@Step" disabled="@Context.IsDisabled" ontouchstart="" @bind="InternalValue" @bind:event="oninput" @bind:after="InvokeValueChangedAsync" />
    </div>
    @if (!string.IsNullOrWhiteSpace(Caption))
    {
        <div class="@CaptionClass">@Caption</div>
    }
</div>

@code {
    private readonly string _id = Random.Shared.Next().ToString();

    /// <summary>
    /// Gets or sets the label displayed above the slider.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Gets or sets helper text displayed under the slider.
    /// </summary>
    [Parameter]
    public string? Caption { get; set; }

    /// <summary>
    /// Gets or sets the unit label displayed with the value.
    /// </summary>
    [Parameter]
    public string? Unit { get; set; }

    /// <summary>
    /// Gets or sets the current slider value.
    /// </summary>
    [Parameter]
    public int Value { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<int> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the increment between allowed values.
    /// </summary>
    [Parameter]
    public int Step { get; set; } = 1;

    /// <summary>
    /// Gets or sets the minimum allowed value.
    /// </summary>
    [Parameter]
    public int MinValue { get; set; }

    /// <summary>
    /// Gets or sets a custom label for the minimum value.
    /// </summary>
    [Parameter]
    public string? MinValueLabel { get; set; }

    /// <summary>
    /// Gets or sets the maximum allowed value.
    /// </summary>
    [Parameter]
    public int MaxValue { get; set; } = 100;

    /// <summary>
    /// Gets or sets a custom label for the maximum value.
    /// </summary>
    [Parameter]
    public string? MaxValueLabel { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the current value is shown in the label.
    /// </summary>
    [Parameter]
    public bool IsShowingValue { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the maximum value is shown in the label.
    /// </summary>
    [Parameter]
    public bool IsShowingMaxValue { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether percentage progress is shown in the label.
    /// </summary>
    [Parameter]
    public bool IsShowingPercentage { get; set; }

    /// <summary>
    /// Gets or sets whether the slider should stretch to full width.
    /// </summary>
    [Parameter]
    public bool? IsFullWidth { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the control shows an edited indicator.
    /// </summary>
    [Parameter]
    public bool IsEdited { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the slider is disabled.
    /// </summary>
    [Parameter]
    public bool IsDisabled { get; set; }

    /// <summary>
    /// Gets or sets user data associated with the component.
    /// </summary>
    [Parameter]
    public object? Tag { get; set; }

    [CascadingParameter]
    private UIContext ParentContext { get; set; } = new();

    private UIContext Context => ParentContext with { IsDisabled = ParentContext.IsDisabled || IsDisabled };

    private double Percentage => MaxValue == MinValue ? 100.0 : ((double)(Value - MinValue) / (double)(MaxValue - MinValue)) * 100.0;

    private int InternalValue
    {
        get => Value;
        set
        {
            if (!Context.IsDisabled && value != Value && value >= MinValue && value <= MaxValue && IsStepCompliant(value))
            {
                Value = value;
            }
        }
    }

    private string LabelClass => Context.IsDisabled ? "dp-label-disabled" : "dp-label";

    private string EditIndicatorClass
    {
        get
        {
            if (IsEdited)
            {
                return Context.IsDisabled ? "dp-edit-indicator-disabled" : "dp-edit-indicator";
            }

            return "dp-edit-indicator-inactive";
        }
    }

    private string SliderClass => Context.IsDisabled ? "dp-slider-disabled" : "dp-slider";

    private string FillClass => Context.IsDisabled ? "dp-slider-fill-disabled" : "dp-slider-fill";

    private string CaptionClass
    {
        get
        {
            var captionClass = Context.IsDisabled ? "dp-caption-disabled" : "dp-caption";

            if (!string.IsNullOrWhiteSpace(Label))
            {
                captionClass += " px-3";

            }

            return captionClass;
        }
    }

    private string WidthClass
    {
        get
        {
            if (IsFullWidth == true)
            {
                return "w-full min-w-fit";
            }

            if (IsFullWidth == false)
            {
                return "w-64";
            }

            return "w-full sm:w-64 min-w-fit";
        }
    }

    private async Task InvokeValueChangedAsync()
    {
        if (!Context.IsDisabled && ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(Value);
        }
    }

    private bool IsStepCompliant(double value)
    {
        if (value == MinValue || value == MaxValue)
        {
            return true;
        }

        return (value - MinValue) % Step == 0;
    }
}
