@implements ITaggable

<div class="space-y-3 @WidthClass">
    <div>
        @if (!string.IsNullOrWhiteSpace(Label))
        {
            <label for="@_id" class="dp-label-base">
                <span class="@LabelClass">@Label</span>
                <span class="@EditIndicatorClass">‚óè</span>
            </label>
        }
        <div class="relative flex @WidthClass">
            <input id="@_id" class="@InputClass @WidthClass @CaseClass" type="@ActualInputType" placeholder="@Placeholder" size="@Size" maxlength="@MaxLength" readonly="@IsReadOnly" disabled="@Context.IsDisabled" ontouchstart="" @bind-value="InternalValue" @bind-value:event="oninput" @onchange="OnChangeAsync" @onkeypress="OnKeyPressAsync" />
            @if (IsLoading)
            {
                <img src="/_content/ChatAIze.DopamineUI/img/loading.gif" width="26" height="26" class="absolute p-1 rounded-lg right-2 top-2 backdrop-blur-sm dark:hidden" />
                <img src="/_content/ChatAIze.DopamineUI/img/loading-dark.gif" width="26" height="26" class="absolute hidden p-1 rounded-lg top-2 right-2 backdrop-blur-sm dark:inline" />
            }
        </div>
    </div>
    @if (!string.IsNullOrWhiteSpace(Caption))
    {
        <div class="@CaptionClass">@Caption</div>
    }
</div>

@code {
    private readonly string _id = Random.Shared.Next().ToString();

    /// <summary>
    /// Gets or sets the input type used for the text field.
    /// </summary>
    [Parameter]
    public TextFieldType Type { get; set; }

    /// <summary>
    /// Gets or sets the label displayed above the text field.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Gets or sets helper text displayed under the text field.
    /// </summary>
    [Parameter]
    public string? Caption { get; set; }

    /// <summary>
    /// Gets or sets the placeholder text displayed when the value is empty.
    /// </summary>
    [Parameter]
    public string? Placeholder { get; set; }

    /// <summary>
    /// Gets or sets the current text value.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    /// <summary>
    /// Gets or sets the input size attribute.
    /// </summary>
    [Parameter]
    public int Size { get; set; } = 25;

    /// <summary>
    /// Gets or sets the maximum length allowed.
    /// </summary>
    [Parameter]
    public int MaxLength { get; set; } = 100;

    /// <summary>
    /// Gets or sets whether the text field should stretch to full width.
    /// </summary>
    [Parameter]
    public bool? IsFullWidth { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the input is forced to lowercase.
    /// </summary>
    [Parameter]
    public bool IsLowercase { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the input is read-only.
    /// </summary>
    [Parameter]
    public bool IsReadOnly { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the control shows an edited indicator.
    /// </summary>
    [Parameter]
    public bool IsEdited { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the text field is in a loading state.
    /// </summary>
    [Parameter]
    public bool IsLoading { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the text field is disabled.
    /// </summary>
    [Parameter]
    public bool IsDisabled { get; set; }

    /// <summary>
    /// Gets or sets user data associated with the component.
    /// </summary>
    [Parameter]
    public object? Tag { get; set; }

    /// <summary>
    /// Gets or sets the callback invoked when Enter is pressed.
    /// </summary>
    [Parameter]
    public EventCallback EnterPressed { get; set; }

    [CascadingParameter]
    private UIContext ParentContext { get; set; } = new();

    private UIContext Context => ParentContext with { IsDisabled = ParentContext.IsDisabled || IsLoading || IsDisabled };

    private string InternalValue
    {
        get => Value ?? string.Empty;
        set
        {
            if (IsReadOnly || Context.IsDisabled)
            {
                return;
            }

            var normalizedValue = NormalizeValue(value);
            if (NormalizeValue(Value) != normalizedValue)
            {
                Value = value;

                if (ValueChanged.HasDelegate)
                {
                    ValueChanged.InvokeAsync(normalizedValue);
                }
            }
            else
            {
                Value = value;
            }
        }
    }

    private string ActualInputType
    {
        get
        {
            return Type switch
            {
                TextFieldType.Search => "search",
                TextFieldType.URL => "url",
                TextFieldType.Phone => "tel",
                TextFieldType.Email => "email",
                TextFieldType.Password => "password",
                _ => "text",
            };
        }
    }

    private string LabelClass => Context.IsDisabled ? "dp-label-disabled" : "dp-label";

    private string EditIndicatorClass
    {
        get
        {
            if (IsEdited)
            {
                return Context.IsDisabled ? "dp-edit-indicator-disabled" : "dp-edit-indicator";
            }

            return "dp-edit-indicator-inactive";
        }
    }

    private string InputClass
    {
        get
        {
            if (IsLoading)
            {
                return "dp-textfield-loading";
            }

            if (Context.IsDisabled)
            {
                return "dp-textfield-disabled";
            }

            return "dp-textfield";
        }
    }

    private string CaseClass => IsLowercase ? "lowercase" : string.Empty;

    private string CaptionClass => Context.IsDisabled ? "dp-caption-disabled px-3" : "dp-caption px-3";

    private string WidthClass
    {
        get
        {
            if (IsFullWidth == true)
            {
                return "w-full min-w-fit";
            }

            if (IsFullWidth == false)
            {
                return "w-fit";
            }

            return "w-full sm:w-fit min-w-fit";
        }
    }

    private string NormalizeValue(string? value)
    {
        if (value == null)
        {
            return string.Empty;
        }

        if (value.Length > MaxLength)
        {
            value = value.Substring(0, MaxLength);
        }

        if (IsLowercase)
        {
            value = value.ToLower();
        }

        return value;
    }

    private async Task OnChangeAsync(ChangeEventArgs e)
    {
        var normalizedValue = NormalizeValue(e.Value?.ToString()?.Trim() ?? string.Empty);
        if (Value != normalizedValue)
        {
            Value = normalizedValue;

            if (ValueChanged.HasDelegate)
            {
                await ValueChanged.InvokeAsync(normalizedValue);
            }
        }
    }

    private async Task OnKeyPressAsync(KeyboardEventArgs e)
    {
        if (!Context.IsDisabled && EnterPressed.HasDelegate && e.Key == "Enter")
        {
            await EnterPressed.InvokeAsync();
        }
    }
}
